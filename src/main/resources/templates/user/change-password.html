<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/basic">

	<th:block layout:fragment="content">
		<div id="container">
			<div class="join_box">
				<form th:action="@{/users/account/} + ${username}" onsubmit="return validationOfForm(this)">
					<p class="page_title">비밀번호 수정</p>
					<div class="box">
						<div class="box_cont form_write">
							<dl>
								<dt>현재 비밀번호</dt>
								<dd>
									<input type="password" name="password" maxlength="50" placeholder="현재 비밀번호를 입력해 주세요." />
								</dd>
							</dl>
							<dl>
								<dt>새로운 비밀번호</dt>
								<dd>
									<input type="password" name="newPassword" maxlength="50" placeholder="영문, 숫자, 특수문자를 포함하여 8~20자 이하로 입력해 주세요." />
								</dd>
							</dl>
							<dl>
								<dt>새로운 비밀번호 확인</dt>
								<dd>
									<input type="password" name="newPasswordCheck" maxlength="50" placeholder="새로운 비밀번호를 한번 더 입력해 주세요." />
								</dd>
							</dl>
						</div>
					</div>

					<div class="btn_wrap text_center">
						<input type="submit" value="변경하기" class="btn btn_black wp100" />
					</div>
				</form>
			</div>
			<!--/* //.join_box */-->
		</div>
		<!--/* //#container */-->
	</th:block>

	<th:block layout:fragment="script">
		<script th:inline="javascript">
			/* <![CDATA[ */

			function validationOfForm(form) {

				var result = (
							   isValid(form.password, "현재 비밀번호", null, null)
							&& isValid(form.newPassword, "새로운 비밀번호", null, null)
							&& equals(form.newPassword, form.newPasswordCheck, "새로운 비밀번호")
				);

				if (result == false) {
					return false;
				}

				/*[- ajax 요청에 필요한 key, value 형태의 오브젝트 생성 -]*/
				var params = makeAjaxRequestData(form);
				if (isEmpty(params)) {
					alert("오류가 발생하였습니다. 새로고침 후에 다시 시도해 주세요.");
					return false;
				}

				/*[- spring security csrf token -]*/
				var token = $("meta[name='_csrf']").attr("content");

				$.ajax({
					url : form.action,
					type : "patch",
					headers: {
						"X-HTTP-Method-Override" : "patch",
						"X-CSRF-TOKEN" : token,
					},
					dataType : "json",
					data : params,
					async : false,
					success : function(response) {
						if (isEmpty(response.message) == false) {
							alert(response.message);
							return false;
						}

						alert("비밀번호가 정상적으로 변경되었습니다. 다시 로그인해 주세요.");
						document.getElementById("logoutForm").submit();
					},
					error : function(request, status, error) {
						alert("오류가 발생하였습니다. 새로고침 후에 다시 시도해 주세요.");
					}
				});
				/*[- end of ajax -]*/

				return false;
			}
			/*[- end of function -]*/

			/* ]]> */
		</script>
	</th:block>

</html>